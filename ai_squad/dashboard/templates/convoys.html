{% extends "base.html" %}

{% block title %}AI-Squad Dashboard - Convoys{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800">Convoys</h1>
    <p class="text-gray-600 mt-2">Monitor parallel work batches</p>
</div>

<!-- Stats -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="stat-card">
        <div class="stat-value" id="total-convoys">-</div>
        <div class="stat-label">Total</div>
    </div>
    <div class="stat-card bg-gradient-to-br from-yellow-500 to-yellow-600">
        <div class="stat-value" id="pending-convoys">-</div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600">
        <div class="stat-value" id="running-convoys">-</div>
        <div class="stat-label">Running</div>
    </div>
    <div class="stat-card bg-gradient-to-br from-green-500 to-green-600">
        <div class="stat-value" id="completed-convoys">-</div>
        <div class="stat-label">Completed</div>
    </div>
</div>

<!-- Convoys List -->
<div class="card">
    <h2 class="text-xl font-semibold mb-4">All Convoys</h2>
    <div id="convoys-list">
        <div class="animate-pulse">
            <div class="h-20 bg-gray-200 rounded mb-4"></div>
            <div class="h-20 bg-gray-200 rounded"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadConvoys() {
    try {
        const res = await fetch('/api/convoys');
        const data = await res.json();
        
        if (!data.success) {
            console.error('Failed to load convoys:', data.error);
            return;
        }
        
        const convoys = data.data;
        
        // Stats
        document.getElementById('total-convoys').textContent = convoys.length;
        document.getElementById('pending-convoys').textContent = 
            convoys.filter(c => c.status === 'pending').length;
        document.getElementById('running-convoys').textContent = 
            convoys.filter(c => c.status === 'running').length;
        document.getElementById('completed-convoys').textContent = 
            convoys.filter(c => c.status === 'completed').length;
        
        // List
        if (convoys.length > 0) {
            document.getElementById('convoys-list').innerHTML = convoys.map(c => `
                <div class="border rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-semibold text-lg">${c.name}</h3>
                            <span class="text-sm text-gray-500">${c.id}</span>
                        </div>
                        <span class="px-3 py-1 rounded text-sm ${
                            c.status === 'completed' ? 'bg-green-100 text-green-800' :
                            c.status === 'running' ? 'bg-blue-100 text-blue-800' :
                            c.status === 'failed' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                        }">${c.status}</span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mt-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Progress</span>
                            <span>${c.progress.progress_percent}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full ${
                                c.status === 'completed' ? 'bg-green-500' :
                                c.status === 'running' ? 'bg-blue-500' :
                                c.status === 'failed' ? 'bg-red-500' :
                                'bg-yellow-500'
                            }" style="width: ${c.progress.progress_percent}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>${c.progress.completed} / ${c.progress.total} members</span>
                            <span>${c.progress.failed} failed</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            document.getElementById('convoys-list').innerHTML = 
                '<p class="text-gray-500">No convoys found</p>';
        }
        
    } catch (e) {
        console.error('Error loading convoys:', e);
    }
}

setupAutoRefresh(loadConvoys);
</script>
{% endblock %}
